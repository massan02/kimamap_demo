# 気ままっぷ 機能実装優先順位（ゼロから構築）

## 前提条件

- **現状**: 空のディレクトリ（Spec Kit テンプレートのみ）
- **目標**: 最小構成から段階的に機能追加
- **方針**: 動くものを早く作り、反復的に改善

---

## Phase 1: プロジェクト基盤構築（1-2 日目）

### 目標

アプリが起動し、基本的な画面遷移ができる状態

### 1-1. Expo プロジェクトのセットアップ ⭐⭐⭐

**優先度: 最高**

```bash
npx create-expo-app@latest . --template blank-typescript
```

- [x] Expo SDK 54 のインストール
- [x] TypeScript 設定
- [x] 基本的なディレクトリ構造作成
- [x] 動作確認（Hello World 表示）

**理由**: プロジェクトの基盤
**依存**: なし
**所要時間**: 30 分

---

### 1-2. ナビゲーション構築 ⭐⭐⭐

**優先度: 最高**

- [x] React Navigation インストール
- [x] Bottom Tabs Navigator 実装（3 タブ）
  - Map タブ
  - 保存済み タブ（※現在は SavedScreen 削除済み、Profile と Map のみ）
  - マイページ タブ
- [ ] Stack Navigator 実装（検索画面など）
- [x] ダミー画面作成（各タブ用）

**理由**: アプリの骨格
**依存**: 1-1 完了後
**所要時間**: 2-3 時間

```
app/
├── navigation/
│   ├── BottomTabNavigator.tsx
│   └── types.ts
└── screens/
    ├── MapScreen.tsx
    ├── ProfileScreen.tsx
```

---

### 1-3. 認証機能実装 ⭐⭐⭐

**優先度: 最高**

- [x] Supabase プロジェクト作成・設定
- [x] Supabase JS Client インストール
- [x] Google OAuth 設定（Supabase コンソール）
- [x] AuthContext 実装（セッション管理）
- [x] ログイン画面実装
- [x] ログアウト機能実装
- [x] 認証状態による画面分岐

**理由**: ユーザーデータを扱うための前提
**依存**: 1-2 完了後
**所要時間**: 4-5 時間

```
app/
├── contexts/
│   └── AuthContext.tsx
├── screens/
│   └── LoginScreen.tsx
└── lib/
    └── supabase.ts
```

---

**Phase 1 完了時点**: アプリ起動 → ログイン → 3 画面のタブ切り替え可能

> [!IMPORTANT] > **トラブルシューティング記録 (Supabase Auth)**
>
> - **現象**: Google ログイン後、アプリに戻らず `cannot GET /` エラー（または Site URL へのリダイレクト）が発生。
> - **原因**: `Redirect URLs` に登録した URL と、アプリから送信した `redirectTo` URL が微妙に不一致（末尾スラッシュの有無など）だったため、Supabase が拒否し、フォールバックとして `Site URL` に飛ばしていた。
> - **解決策**:
>   1. `Redirect URLs` に開発用 (`exp://...`) と本番用 (`kimamap://...`) を両方登録する。
>   2. `Site URL` も本番用または Web 用の有効な URL に設定しておく（保険）。
>   3. クライアント側は `Linking.createURL()` を使用して環境に応じた正しい URL を生成する。

---

## Phase 2: 地図表示機能（3-4 日目）

### 目標

地図を表示し、現在地を取得できる状態

### 2-1. Google Maps 基本表示 ⭐⭐⭐

**優先度: 最高**

- [x] react-native-maps インストール
- [ ] Google Maps API キー取得・設定（※現在はテスト用にキーなしで動作中/シミュレーター）
- [x] MapScreen に地図表示
- [x] 初期表示位置設定（福岡市など）
- [ ] 地図操作確認（ズーム、パン）

**理由**: アプリのコア画面
**依存**: Phase 1 完了後
**所要時間**: 2-3 時間

---

### 2-2. 位置情報取得 ⭐⭐⭐

**優先度: 最高**

- [x] expo-location インストール
- [x] 位置情報パーミッション取得
- [x] 現在地取得機能実装
- [x] 現在地に地図を移動
- [x] 現在地マーカー表示

**理由**: ユーザーの現在地を起点にプラン作成
**依存**: 2-1 完了後
**所要時間**: 2-3 時間

---

### 2-3. 検索バー UI ⭐⭐

**優先度: 高**

- [x] 地図画面上部に検索バー配置
- [x] タップで検索画面に遷移（Stack Navigator）
- [x] 基本的なスタイリング

**理由**: ユーザーがプラン作成を開始するエントリーポイント
**依存**: 2-1 完了後（2-2 と並行可能）
**所要時間**: 1-2 時間

---

### 2-4. 天気ウィジェット（オプション）⭐

**優先度: 中**

- [ ] Open-Meteo API 統合
- [ ] 現在地の天気情報取得
- [ ] 天気ウィジェット UI 作成
- [ ] 地図画面に配置

**理由**: UX 向上（後回しでも OK）
**依存**: 2-2 完了後
**所要時間**: 2-3 時間

---

**Phase 2 完了時点**: 地図表示 + 現在地取得 + 検索画面への導線完成

---

## Phase 3: 検索・プラン機能（5-7 日目）

### 目標

ユーザーが検索 → AI がプランを提案 → 地図に表示

### 3-1. 検索画面 UI 実装 ⭐⭐⭐

**優先度: 最高**

- [x] 要望入力フィールド（テキストエリア）✅
- [x] 移動手段選択（徒歩・自転車・自動車）✅
- [x] 時間選択（プリセット）✅
- [ ] 気分選択（オプション）※Phase 5 へ延期
- [x] 検索ボタン ✅
- [x] バリデーション実装 ✅

**理由**: ユーザー入力を受け付ける
**依存**: Phase 2 完了後
**所要時間**: 3-4 時間

```
app/screens/SearchScreen.tsx
```

---

### 3-2. バックエンドサーバー構築 ⭐⭐⭐

**優先度: 最高**

- [x] `server/` ディレクトリ作成 ✅
- [x] Express 5.1 インストール・設定 ✅
- [x] TypeScript 設定 ✅
- [x] `/api/plan` エンドポイント作成（POST）✅
- [x] リクエスト型定義（Zod）✅
- [x] 開発サーバー起動確認 ✅

**理由**: AI プランロジックを実行する場所
**依存**: Phase 2 完了後（3-1 と並行可能）
**所要時間**: 2-3 時間

```
server/
├── src/
│   ├── index.ts
│   ├── routes/
│   │   └── planRoutes.ts
│   ├── controllers/
│   │   └── planController.ts
│   └── types/
│       └── schemas.ts
├── package.json
└── tsconfig.json
```

---

### 3-3. モックデータ作成 ⭐⭐

**優先度: 高**

- [x] 福岡エリアのスポットデータ作成（JSON）✅
  - 名前、カテゴリ、座標、滞在時間
- [x] 20-30 件のスポットデータ ✅
- [x] スポット読み込み処理実装 ✅

**理由**: AI プランロジックのデータソース
**依存**: 3-2 完了後
**所要時間**: 2-3 時間

```
server/data/spots.json
```

---

### 3-4. AI プランロジック実装 ⭐⭐⭐

**優先度: 最高**

- [ ] ユーザー入力からスポット選択アルゴリズム
  - 時間制約内に収まるスポット組み合わせ
  - 移動手段に応じた移動時間計算
  - 気分に合わせたカテゴリフィルタリング
- [ ] ルート最適化（貪欲法・巡回セールスマン問題の簡易版）
- [ ] レスポンス生成
- [ ] テスト実装

**理由**: アプリのコア機能
**依存**: 3-3 完了後
**所要時間**: 5-6 時間

---

### 3-5. フロントエンド-バックエンド接続 ⭐⭐⭐

**優先度: 最高**

- [x] API クライアント実装（fetch/axios）✅
- [x] 検索ボタン押下時に API リクエスト送信 ✅
- [x] レスポンス受信・パース ✅
- [x] ローディング状態表示 ✅
- [x] エラーハンドリング ✅
- [x] CORS 設定 ✅

**理由**: フロントとバックを繋ぐ
**依存**: 3-2, 3-4 完了後
**所要時間**: 2-3 時間

```
app/services/api.ts
```

---

### 3-6. 地図上のルート描画 ⭐⭐⭐

**優先度: 最高**

- [ ] プラン取得後、地図画面に遷移
- [ ] `Polyline` でルート描画
- [ ] 複数スポット間のルート表示
- [ ] 地図の自動ズーム調整（全ルートが見える範囲）
- [ ] ルート色・太さの調整

**理由**: プラン結果の視覚化
**依存**: 3-5 完了後
**所要時間**: 2-3 時間

---

### 3-7. 地図上のマーカー表示 ⭐⭐⭐

**優先度: 最高**

- [ ] スポットごとにマーカー配置
- [ ] マーカー番号表示（訪問順: 1→2→3...）
- [ ] マーカータップでスポット情報表示（Callout）
  - スポット名、滞在時間、カテゴリ
- [ ] カスタムマーカーデザイン（オプション）

**理由**: どこに行くのかを明確にする
**依存**: 3-6 と並行可能
**所要時間**: 2-3 時間

---

**Phase 3 完了時点**: MVP 完成（検索 → AI プラン生成 → 地図表示）

---

## Phase 4: データ永続化・履歴機能（8-9 日目）

### 目標

ユーザーがプランを保存・再利用できる

### 4-1. Supabase テーブル設計 ⭐⭐

**優先度: 高**

- [ ] `plans` テーブル作成
  ```sql
  - id (UUID)
  - user_id (UUID, foreign key)
  - title (text)
  - spots (jsonb)
  - route (jsonb)
  - is_favorite (boolean)
  - created_at (timestamp)
  ```
- [ ] RLS（Row Level Security）設定
- [ ] テーブル作成 SQL の実行

**理由**: データを永続化する基盤
**依存**: Phase 3 完了後
**所要時間**: 1-2 時間

---

### 4-2. 履歴保存機能 ⭐⭐

**優先度: 高**

- [ ] プラン生成後、自動で Supabase に保存
- [ ] 保存 API クライアント実装
- [ ] エラーハンドリング

**理由**: ユーザーが過去のプランを見返せる
**依存**: 4-1 完了後
**所要時間**: 2-3 時間

---

### 4-3. 保存済み画面実装 ⭐⭐

**優先度: 高**

- [ ] Supabase から履歴取得
- [ ] リスト表示（FlatList）
  - タイトル、日時、スポット数
- [ ] タップでプラン詳細表示
- [ ] プラン詳細画面実装
  - スポットリスト
  - 地図で見る ボタン（地図画面に遷移してルート表示）

**理由**: 保存したプランを確認・再利用
**依存**: 4-2 完了後
**所要時間**: 3-4 時間

---

### 4-4. お気に入り機能 ⭐⭐

**優先度: 高**

- [ ] プラン詳細画面に「お気に入り」ボタン追加
- [ ] Supabase 更新処理（`is_favorite` フラグ）
- [ ] 保存済み画面でお気に入りフィルター
- [ ] お気に入り解除機能

**理由**: 特に気に入ったプランをブックマーク
**依存**: 4-3 完了後
**所要時間**: 2-3 時間

---

**Phase 4 完了時点**: プランの保存・履歴・お気に入り機能が完成

---

## Phase 5: マイページ・その他機能（10-12 日目）

### 5-1. マイページ実装 ⭐

**優先度: 中**

- [ ] ユーザー情報表示
  - Google アカウント名
  - プロフィール画像
- [ ] 統計情報表示
  - 生成プラン数
  - お気に入り数
- [ ] ログアウトボタン

**理由**: ユーザーエンゲージメント向上
**依存**: Phase 4 完了後
**所要時間**: 2-3 時間

---

### 5-2. AI おすすめ機能（基本版）⭐

**優先度: 低**

- [ ] 検索画面に「おすすめ」セクション追加
- [ ] ハードコード 3 件のおすすめ表示
- [ ] タップで検索フォームに自動入力

**理由**: 検索の手間を省く
**依存**: Phase 3 完了後
**所要時間**: 1-2 時間

---

### 5-3. プラン編集機能 ⭐

**優先度: 低**

- [ ] スポット順序の変更（ドラッグ&ドロップ）
- [ ] スポットの削除
- [ ] スポットの追加（検索から）
- [ ] 編集内容の保存

**理由**: プランのカスタマイズ性向上
**依存**: Phase 4 完了後
**所要時間**: 5-6 時間

---

### 5-4. 設定画面

**優先度: 低**

- [ ] デフォルト移動手段設定
- [ ] デフォルト時間設定
- [ ] アプリ情報（バージョン、利用規約）

**理由**: UX 向上
**依存**: なし
**所要時間**: 2-3 時間

---

### 5-5. UI/UX 改善

**優先度: 低**

- [ ] ローディングアニメーション
- [ ] 画面遷移アニメーション
- [ ] エラーメッセージの改善
- [ ] アクセシビリティ対応
- [ ] レスポンシブデザイン調整

**理由**: プロダクト品質向上
**依存**: 継続的
**所要時間**: 継続的

---

## 実装順序サマリー

| Phase | タスク                         | 所要時間 | 累計  |
| ----- | ------------------------------ | -------- | ----- |
| 1-1   | Expo セットアップ              | 30 分    | 0.5h  |
| 1-2   | ナビゲーション構築             | 2-3h     | 3.5h  |
| 1-3   | 認証機能実装                   | 4-5h     | 8.5h  |
| 2-1   | Google Maps 表示               | 2-3h     | 11.5h |
| 2-2   | 位置情報取得                   | 2-3h     | 14.5h |
| 2-3   | 検索バー UI                    | 1-2h     | 16.5h |
| 2-4   | 天気ウィジェット（オプション） | 2-3h     | 19.5h |
| 3-1   | 検索画面 UI                    | 3-4h     | 23.5h |
| 3-2   | バックエンド構築               | 2-3h     | 26.5h |
| 3-3   | モックデータ作成               | 2-3h     | 29.5h |
| 3-4   | AI プランロジック              | 5-6h     | 35.5h |
| 3-5   | フロント-バックエンド接続      | 2-3h     | 38.5h |
| 3-6   | ルート描画                     | 2-3h     | 41.5h |
| 3-7   | マーカー表示                   | 2-3h     | 44.5h |
| 4-1   | Supabase テーブル設計          | 1-2h     | 46.5h |
| 4-2   | 履歴保存機能                   | 2-3h     | 49.5h |
| 4-3   | 保存済み画面                   | 3-4h     | 53.5h |
| 4-4   | お気に入り機能                 | 2-3h     | 56.5h |

**MVP 完成（Phase 3 完了）**: 約 40-45 時間（実働 5-6 日）
**主要機能完成（Phase 4 完了）**: 約 50-57 時間（実働 7-8 日）

---

## 開発の進め方

### 1 週目（MVP 完成目標）

- Day 1: Phase 1（プロジェクト基盤）
- Day 2-3: Phase 1（認証機能）
- Day 4: Phase 2（地図表示）
- Day 5-7: Phase 3（検索・プラン機能）

### 2 週目（主要機能完成）

- Day 8-9: Phase 4（データ永続化）
- Day 10-12: Phase 5（その他機能）+ バグ修正

---

## 次のアクション

1. **Phase 1-1 から着手**

   ```bash
   cd /Users/murasakimasato/school/kimamap_demo
   npx create-expo-app@latest . --template blank-typescript
   ```

2. **各フェーズの開始前に `/speckit.tasks` でタスク分解**

3. **実装は `/speckit.implement` で実行**

4. **定期的に動作確認・テスト**

**最初の一歩**: Expo プロジェクトのセットアップから開始してください。
