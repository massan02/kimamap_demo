# Tasks: ユーザー認証とアプリ基本構造

**Feature**: `001-auth-and-navigation` | **Branch**: `claude/setup-tech-stack-01PzSW7UWecXLx7bgWgu9bN5`
**Generated**: 2025-11-16 | **Status**: Ready for Implementation

---

## 概要

本タスクリストは、ユーザー認証とアプリ基本構造の実装を、ユーザーストーリーごとに独立してテスト可能な単位に分解したものです。

### ユーザーストーリーマッピング

| Story | 優先度 | 説明 | 独立テスト基準 |
|-------|-------|------|-------------|
| US1 | P1 | 初回Googleログイン | Googleログインボタンをタップ→OAuth完了→地図画面とボトムタブが表示される |
| US2 | P2 | メイン画面間のナビゲーション | 各タブをタップ→対応する画面が表示され、タブインジケーターが更新される |
| US3 | P3 | セッションの永続化 | ログイン→アプリ終了→再起動→ログイン状態が維持される |
| US4 | P4 | 安全なログアウト | ログアウトボタンをタップ→ログイン画面に戻り、認証済みコンテンツにアクセスできない |

---

## Phase 1: セットアップ（プロジェクト初期化）

**目標**: Expoプロジェクトを初期化し、必要な依存関係をインストールする

### タスク

- [ ] T001 Expoプロジェクトを初期化（blank-typescriptテンプレート）
- [ ] T002 必要な依存関係をインストール（React Navigation、Supabase、AsyncStorage）
- [ ] T003 TypeScript設定ファイル（tsconfig.json）をstrict modeで設定
- [ ] T004 [P] `.gitignore`ファイルに`.env`を追加
- [ ] T005 [P] `.env.example`ファイルを作成（Supabase URLとAnon Keyのプレースホルダー）
- [ ] T006 Supabaseプロジェクトを作成（https://supabase.com）
- [ ] T007 Google Cloud ConsoleでOAuth 2.0クライアントIDを作成
- [ ] T008 SupabaseダッシュボードでGoogle OAuthプロバイダーを有効化
- [ ] T009 `.env`ファイルを作成し、Supabase認証情報を設定
- [ ] T010 [P] プロジェクトディレクトリ構造を作成（app/contexts、app/navigation、app/screens、app/config、__tests__/integration、__tests__/unit）

**完了基準**:
- `npm start`でExpo開発サーバーが起動する
- TypeScriptコンパイルエラーがない
- Supabaseプロジェクトが稼働中
- 環境変数ファイルが正しく設定されている

---

## Phase 2: 基盤実装（すべてのユーザーストーリーの前提条件）

**目標**: 認証とナビゲーションの基盤となるコア実装を完成させる

### タスク

- [ ] T011 Supabaseクライアント初期化ファイルを作成（app/config/supabase.ts）
- [ ] T012 [P] ナビゲーション型定義ファイルを作成（app/navigation/types.ts）
- [ ] T013 [P] 認証型定義ファイルを作成（app/types/auth.ts）
- [ ] T014 AuthContextを実装（app/contexts/AuthContext.tsx）
- [ ] T015 App.tsxにAuthProviderを統合

**完了基準**:
- Supabaseクライアントが正しく初期化される
- 型定義がすべてstrict modeでコンパイルエラーなし
- AuthContextがセッション状態を管理できる

---

## Phase 3: US1 - 初回Googleログイン (P1)

**ストーリー**: 新規ユーザーが初めて気ままっぷアプリを開き、Googleアカウントでサインインしてアプリの機能にアクセスする

**独立テスト基準**:
- アプリ起動→ログイン画面が表示される
- 「Googleでログイン」ボタンをタップ→Google OAuth同意画面が表示される
- OAuth完了→地図画面とボトムタブ（地図、マイページ）が表示される
- OAuth拒否→ログイン画面に戻り、エラーメッセージが表示される

### タスク

- [ ] T016 [US1] LoginScreen UIを実装（app/screens/LoginScreen.tsx）
- [ ] T017 [US1] LoginScreenに「Googleでログイン」ボタンを追加
- [ ] T018 [US1] Google OAuthログイン処理を実装（supabase.auth.signInWithOAuth）
- [ ] T019 [US1] ネットワークエラー時の自動リトライロジックを実装（2-3回、指数バックオフ）
- [ ] T020 [US1] 認証エラーハンドリングとユーザーフレンドリーなエラーメッセージを実装
- [ ] T021 [US1] OAuth成功後にAuthContextのセッション状態を更新
- [ ] T022 [US1] 認証フローの統合テストを作成（__tests__/integration/auth.test.tsx）

**依存関係**:
- Phase 2（基盤実装）が完了していること
- US2（ナビゲーション）の一部タスク（T023-T029）が並行または先行して完了していること（ログイン成功後の遷移先が必要）

**完了基準**:
- [ ] ログイン画面が表示される
- [ ] Googleログインボタンをタップすると、Google OAuth同意画面が開く
- [ ] OAuth許可後、地図画面に遷移する
- [ ] OAuth拒否時、ログイン画面に戻りエラーメッセージが表示される
- [ ] ネットワークエラー時、自動で2-3回再試行される
- [ ] 統合テストがすべてパスする

---

## Phase 4: US2 - メイン画面間のナビゲーション (P2)

**ストーリー**: 認証済みユーザーがアプリの2つのメインセクション間を移動する：地図（ルート探索用）、マイページ（ユーザープロフィールと設定用）

**独立テスト基準**:
- ログイン後、地図画面がデフォルトで表示される
- 「マイページ」タブをタップ→マイページ画面に移動し、タブインジケーターが更新される
- 「地図」タブをタップ→地図画面に戻り、タブインジケーターが更新される
- タブ間で画面状態が保持される

### タスク

- [ ] T023 [P] [US2] RootNavigatorを実装（app/navigation/RootNavigator.tsx）
- [ ] T024 [P] [US2] RootNavigatorで認証状態に基づく画面分岐を実装（ログイン画面 vs メインタブ）
- [ ] T025 [P] [US2] BottomTabNavigatorを実装（app/navigation/BottomTabNavigator.tsx）
- [ ] T026 [P] [US2] BottomTabNavigatorに2つのタブ（Map、Profile）を追加
- [ ] T027 [P] [US2] MapScreen（プレースホルダー）を実装（app/screens/MapScreen.tsx）
- [ ] T028 [P] [US2] ProfileScreen（基本UI）を実装（app/screens/ProfileScreen.tsx）
- [ ] T029 [US2] App.tsxにRootNavigatorを統合
- [ ] T030 [US2] ProfileScreenにユーザー情報を表示（メールアドレス、プロフィール画像）
- [ ] T031 [US2] ナビゲーションのユニットテストを作成（__tests__/unit/navigation.test.tsx）

**依存関係**:
- Phase 2（基盤実装）が完了していること
- US1のタスクT021（セッション状態更新）が完了していること（認証済み状態でのナビゲーションテストのため）

**完了基準**:
- [ ] ログイン成功後、地図画面（プレースホルダー: "地図機能は準備中です"）が表示される
- [ ] ボトムタブナビゲーションバーに「地図」「マイページ」の2つのタブが表示される
- [ ] 「マイページ」タブをタップすると、マイページ画面に移動する
- [ ] マイページ画面にユーザーのメールアドレスとプロフィール画像が表示される
- [ ] タブ切り替え時、アクティブタブインジケーターが更新される
- [ ] タブ切り替え時間が500ms以内
- [ ] ユニットテストがすべてパスする

---

## Phase 5: US3 - セッションの永続化 (P3)

**ストーリー**: 以前ログインしたユーザーがアプリを閉じて後で再度開いたとき、再認証せずにログイン状態が維持される

**独立テスト基準**:
- ログイン→アプリを完全に終了→30日以内に再起動→ログイン状態が維持され、最後に表示した画面が表示される
- 30日後にアプリを開く→ログイン画面に戻される
- アプリがバックグラウンドに移動→再開→セッションが維持される
- 無効なトークン検出→自動ログアウトされ、ログイン画面に戻される

### タスク

- [ ] T032 [US3] AsyncStorageパッケージをインストール（@react-native-async-storage/async-storage）
- [ ] T033 [US3] Supabase AuthでAsyncStorageを使用するように設定（app/config/supabase.ts）
- [ ] T034 [US3] AuthContextでアプリ起動時にセッション復元ロジックを実装
- [ ] T035 [US3] セッション有効期限チェックロジックを実装
- [ ] T036 [US3] 無効なセッション検出時の自動ログアウト処理を実装
- [ ] T037 [US3] トークン自動リフレッシュの動作確認（onAuthStateChangeリスナー）
- [ ] T038 [US3] セッション永続化の統合テストを追加（__tests__/integration/auth.test.tsx）

**依存関係**:
- US1（ログイン）とUS2（ナビゲーション）が完了していること

**完了基準**:
- [ ] ログイン後、アプリを終了→再起動→ログイン画面をスキップして地図画面が表示される
- [ ] セッション有効期限（30日）後、アプリを開くとログイン画面が表示される
- [ ] アプリがバックグラウンド→フォアグラウンド復帰→セッションが維持される
- [ ] トークンが無効な場合、自動的にログアウトされる
- [ ] 統合テストがすべてパスする

---

## Phase 6: US4 - 安全なログアウト (P4)

**ストーリー**: ユーザーがプライバシーを保護するため、またはアカウントを切り替えるためにアプリからサインアウトする

**独立テスト基準**:
- マイページ画面で「ログアウト」ボタンをタップ→即座にログアウトされ、ログイン画面に戻される
- ログアウト後、認証済み画面（地図、マイページ）へのアクセスを試みる→ログイン画面にリダイレクトされる
- ログアウト後、アプリを再起動→ログイン画面が表示される（セッションが完全にクリアされている）

### タスク

- [ ] T039 [US4] ProfileScreenに「ログアウト」ボタンを追加
- [ ] T040 [US4] ログアウト処理を実装（supabase.auth.signOut）
- [ ] T041 [US4] ログアウト時にAsyncStorageからセッションデータを削除
- [ ] T042 [US4] ログアウト時にAuthContextのセッション状態をnullに更新
- [ ] T043 [US4] ログアウト後のログイン画面へのリダイレクト処理を確認
- [ ] T044 [US4] ログアウト処理の統合テストを追加（__tests__/integration/auth.test.tsx）

**依存関係**:
- US1（ログイン）、US2（ナビゲーション）、US3（セッション永続化）が完了していること

**完了基準**:
- [ ] マイページ画面に「ログアウト」ボタンが表示される
- [ ] ログアウトボタンをタップすると、即座にログイン画面に戻る
- [ ] ログアウト後、AuthContextのセッション状態がnullになる
- [ ] ログアウト後、AsyncStorageからセッションデータが削除される
- [ ] ログアウト後、アプリを再起動してもログイン画面が表示される
- [ ] 統合テストがすべてパスする

---

## Phase 7: 仕上げ・クロスカッティング

**目標**: 全ユーザーストーリーを統合し、品質ゲートをクリアする

### タスク

- [ ] T045 [P] すべての画面でTypeScript strictモードのコンパイルエラーを解消
- [ ] T046 [P] ESLintとPrettierで全ファイルをフォーマット
- [ ] T047 全ユーザーストーリーのエンドツーエンドテストを実行
- [ ] T048 パフォーマンステスト（認証フロー30秒以内、タブ切り替え500ms以内）
- [ ] T049 エラーメッセージの改善とユーザビリティ確認
- [ ] T050 セキュリティチェック（`.env`がgitignore、トークンが安全に保存されている）
- [ ] T051 手動QAチェックリストを作成し、全受け入れシナリオをテスト
- [ ] T052 Constitution準拠性確認（クリーンな基盤、型安全性、シンプル優先、最新スタック、テスト品質）

**完了基準**:
- [ ] すべての機能要件（FR-001 ~ FR-019）を満たしている
- [ ] 4つのユーザーストーリーの受け入れシナリオがすべてパス
- [ ] TypeScript strictモードでビルドエラーなし
- [ ] 認証フローのユニットテスト・統合テストが通過
- [ ] ナビゲーションのユニットテストが通過
- [ ] パフォーマンス目標達成（認証30秒以内、タブ切り替え500ms以内、初回認証成功率95%以上）
- [ ] セキュリティ確認完了（環境変数がgitignore、セッショントークンが安全に保存）
- [ ] Constitution準拠性確認完了

---

## 依存関係グラフ

### ユーザーストーリー完了順序

```
Phase 1 (セットアップ)
  ↓
Phase 2 (基盤実装)
  ↓
Phase 3 (US1: ログイン) ←→ Phase 4 (US2: ナビゲーション) [相互依存・並行開発可能]
  ↓
Phase 5 (US3: セッション永続化)
  ↓
Phase 6 (US4: ログアウト)
  ↓
Phase 7 (仕上げ)
```

### ブロッキング依存関係

- **Phase 2** → すべてのフェーズ（基盤なしでは何も実装できない）
- **Phase 3 + Phase 4** → Phase 5（ログインとナビゲーションがないとセッション永続化をテストできない）
- **Phase 5** → Phase 6（セッション管理がないとログアウトが実装できない）

### 並行実行可能なタスク

#### Phase 1（セットアップ）
- T004, T005, T010（プロジェクト設定タスク）は並行実行可能
- T006, T007, T008（Supabase/Google OAuth設定）は並行実行可能

#### Phase 2（基盤実装）
- T012, T013（型定義）は並行実行可能

#### Phase 3 + Phase 4（ログイン + ナビゲーション）
- US1とUS2のタスクは並行開発可能：
  - T016-T021（US1: ログイン画面）と T023-T028（US2: ナビゲーション）を並行実装
  - T029（統合）の前に両方完了させる

#### Phase 7（仕上げ）
- T045, T046（コード整形）は並行実行可能

---

## 並行実行例

### 例1: セットアップフェーズ（Phase 1）

**並行グループ1**（プロジェクト設定）:
```bash
# ターミナル1
Task T004: .gitignoreに.envを追加

# ターミナル2
Task T005: .env.exampleを作成

# ターミナル3
Task T010: ディレクトリ構造を作成
```

**並行グループ2**（外部サービス設定）:
```bash
# ブラウザタブ1
Task T006: Supabaseプロジェクト作成

# ブラウザタブ2
Task T007: Google Cloud ConsoleでOAuth設定

# ブラウザタブ3
Task T008: SupabaseでGoogle OAuth有効化
```

### 例2: US1（ログイン）+ US2（ナビゲーション）並行開発

```bash
# 開発者A: US1（ログイン）を担当
Task T016: LoginScreen UIを実装
Task T017: Googleログインボタンを追加
Task T018: OAuth処理を実装
...

# 開発者B: US2（ナビゲーション）を担当（並行）
Task T023: RootNavigatorを実装
Task T025: BottomTabNavigatorを実装
Task T027: MapScreenを実装
Task T028: ProfileScreenを実装
...

# 両方完了後に統合
Task T029: App.tsxにRootNavigatorを統合
```

---

## 実装戦略

### MVP優先アプローチ

**MVP（Minimum Viable Product）**:
- **Phase 1-3のみ（US1: 初回Googleログイン）**
- これだけで「ユーザーがログインできる」という最小限の価値を提供
- 所要時間: 約3-4時間

**推奨実装順序**:
1. MVP（Phase 1-3）を最初に完成させる
2. US2（ナビゲーション）を追加→ユーザーが画面を移動できる
3. US3（セッション永続化）を追加→ユーザーが再ログイン不要に
4. US4（ログアウト）を追加→セキュリティとプライバシー保護
5. Phase 7（仕上げ）→品質ゲートクリア

### インクリメンタル配信

各ユーザーストーリー完了後、独立してテスト可能:
- **US1完了後**: ログインフローのみテスト
- **US2完了後**: ログイン→ナビゲーションをテスト
- **US3完了後**: セッション永続化をテスト
- **US4完了後**: ログアウトをテスト

---

## タスクサマリー

**総タスク数**: 52タスク

| Phase | タスク数 | 並行実行可能数 | 予想所要時間 |
|-------|---------|-------------|-----------|
| Phase 1: セットアップ | 10 | 6 | 1-1.5時間 |
| Phase 2: 基盤実装 | 5 | 2 | 1-1.5時間 |
| Phase 3: US1（ログイン） | 7 | 0 | 2-3時間 |
| Phase 4: US2（ナビゲーション） | 9 | 6 | 2-3時間 |
| Phase 5: US3（セッション永続化） | 7 | 0 | 1.5-2時間 |
| Phase 6: US4（ログアウト） | 6 | 0 | 1-1.5時間 |
| Phase 7: 仕上げ | 8 | 2 | 1.5-2時間 |

**合計予想時間**: 10-15時間（実働2日）

**並行実行機会**: 16タスク（全体の31%）

---

## チェックリスト形式の検証

✅ すべてのタスクが `- [ ] [TaskID]` 形式に従っている
✅ 並行実行可能タスクに `[P]` マーカーが付いている
✅ ユーザーストーリータスクに `[US1]`, `[US2]`, `[US3]`, `[US4]` ラベルが付いている
✅ 各タスクに具体的なファイルパスが含まれている
✅ 各フェーズに独立したテスト基準が定義されている
✅ 依存関係が明確に文書化されている

---

## 次のステップ

1. **実装開始**: `/speckit.implement` コマンドで実装を開始
2. **進捗追跡**: 各タスク完了時にチェックボックスをマーク
3. **品質確認**: 各フェーズ完了後に完了基準を満たしているか確認

**推奨MVP**: Phase 1-3（US1: 初回Googleログイン）から開始してください。

---

**このタスクリストは `/speckit.tasks` コマンドにより生成されました。**
