# 機能仕様書: ユーザー認証とアプリ基本構造

**機能ブランチ**: `001-auth-and-navigation`
**作成日**: 2025-11-16
**ステータス**: ドラフト
**入力**: ユーザー説明: "ユーザー認証とアプリ基本構造。Googleログイン、セッション管理、2画面のボトムタブナビゲーション（地図・マイページ）、ログアウト機能を提供する"

## 明確化 (Clarifications)

### セッション 2025-11-16

- Q: 認証バックエンドサービス - 認証トークンの管理とセッション永続化に使用するバックエンドサービスはどれか？ → A: Supabase Authを使用

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 初回Googleログイン (優先度: P1)

新規ユーザーが初めて気ままっぷアプリを開き、Googleアカウントでサインインしてアプリの機能にアクセスする必要がある。

**優先度の理由**: 認証はアプリケーション全体へのエントリーポイントです。これがなければ、ユーザーはどの機能にもアクセスできません。最も重要なユーザージャーニーです。

**独立テスト**: アプリを起動し、Googleログインボタンをタップし、OAuthフローを完了し、ユーザーにメインナビゲーションインターフェースが表示されることを確認することで完全にテストできます。安全なユーザーアクセスというコア価値を提供します。

**受け入れシナリオ**:

1. **前提** 新規ユーザーがアプリを開く、**操作** 「Googleでログイン」をタップする、**結果** GoogleのOAuth同意画面にリダイレクトされる
2. **前提** ユーザーがGoogleの同意画面で権限を許可する、**操作** 認証を完了する、**結果** アプリに戻り、2つのタブ（地図、マイページ）を持つボトムタブナビゲーションが表示される
3. **前提** ユーザーがGoogleの同意画面にいる、**操作** キャンセルまたは権限を拒否する、**結果** ログイン画面に戻り、認証が必要であることを説明する明確なメッセージが表示される
4. **前提** ユーザーがGoogleログインを完了する、**操作** 認証が成功する、**結果** 基本プロフィール情報（名前、メールアドレス、プロフィール画像）がマイページセクションに表示できるようになる

---

### ユーザーストーリー 2 - メイン画面間のナビゲーション (優先度: P2)

認証済みユーザーがアプリの2つのメインセクション間を移動する必要がある：地図（ルート探索用）、マイページ（ユーザープロフィールと設定用）。

**優先度の理由**: ナビゲーションは異なるアプリ機能へのアクセスに不可欠です。ログイン後、ユーザーは異なるセクションを探索する必要があります。機能の発見を可能にするため、2番目に重要なジャーニーです。

**独立テスト**: ログインして各ボトムタブをタップし、各画面が正しく読み込まれ、アクティブタブインジケーターが更新されることを確認することで完全にテストできます。コアナビゲーション構造を提供します。

**受け入れシナリオ**:

1. **前提** ユーザーがログインして地図画面を表示している、**操作** 「マイページ」タブをタップする、**結果** アプリがマイページ画面に移動し、マイページタブインジケーターがハイライトされる
2. **前提** ユーザーがマイページ画面にいる、**操作** 「地図」タブをタップする、**結果** アプリが地図画面に移動し、地図タブインジケーターがハイライトされる
3. **前提** ユーザーがタブ間を移動する、**操作** 以前に表示したタブに戻る、**結果** 画面の状態が保持される（例：地図の位置、スクロール位置）

---

### ユーザーストーリー 3 - セッションの永続化 (優先度: P3)

以前ログインしたユーザーがアプリを閉じて後で再度開いたとき、再認証せずにログイン状態が維持されることを期待する。

**優先度の理由**: セッションの永続化は、繰り返しのログイン手順を排除することでユーザー体験を向上させます。ユーザビリティにとって重要ですが、ユーザーはこれなしでもアプリを使用できるため、初回認証とナビゲーションよりも優先度は低くなります。

**独立テスト**: ログインし、アプリを完全に閉じ、再度開き、ユーザーが自動的にログインされ、最後に表示した画面が表示されることを確認することで完全にテストできます。ユーザーの利便性向上を提供します。

**受け入れシナリオ**:

1. **前提** ユーザーが正常にログインしている、**操作** アプリを閉じて30日以内に再度開く、**結果** 認証状態が維持され、最後に表示した画面が表示される
2. **前提** ユーザーのセッションが期限切れになっている（30日後）、**操作** アプリを開く、**結果** ログイン画面に戻される
3. **前提** ユーザーがアプリを使用中である、**操作** アプリがバックグラウンドに移動し、再開される、**結果** セッションが維持され、中断した場所から継続できる
4. **前提** ユーザーの認証トークンが無効または取り消されている、**操作** アプリを開く、**結果** 安全にログアウトされ、ログイン画面に戻される

---

### ユーザーストーリー 4 - 安全なログアウト (優先度: P4)

ユーザーがプライバシーを保護するため、またはアカウントを切り替えるためにアプリからサインアウトしたい。

**優先度の理由**: ログアウトはセキュリティとプライバシーにとって重要ですが、ログインやナビゲーションと比較して頻度の低いアクションです。ユーザーは通常、アカウントを切り替える場合や共有デバイスでのみログアウトします。

**独立テスト**: ログインし、マイページに移動し、ログアウトをタップし、ユーザーがログイン画面に戻され、認証済みコンテンツにアクセスできないことを確認することで完全にテストできます。セキュリティとアカウント切り替え機能を提供します。

**受け入れシナリオ**:

1. **前提** ログイン済みユーザーがマイページ画面にいる、**操作** 「ログアウト」ボタンをタップする、**結果** 即座にログアウトされ、ログイン画面に戻される
2. **前提** ユーザーがログアウトした、**操作** 認証済み画面（地図、マイページ）へのアクセスを試みる、**結果** ログイン画面にリダイレクトされる
3. **前提** ユーザーがログアウトする、**操作** アプリを再度開く、**結果** アプリにアクセスするために再度認証する必要がある
4. **前提** ユーザーがログアウトをタップする、**操作** ログアウト処理が完了する、**結果** すべてのローカルセッションデータがクリアされ、認証状態が取り消される

---

### エッジケース

- Googleログイン中にユーザーのインターネット接続が失われた場合どうなるか？
- Google OAuthがエラーを返したり、ユーザーのGoogleアカウントが停止されたりした場合、システムはどう処理するか？
- ユーザーが追加の権限を必要とするタブ（地図画面の位置情報など）にアクセスしようとした場合どうなるか？
- ユーザーがログイン中にGoogleアカウント設定からGoogle権限を取り消した場合、アプリはどう動作するか？
- ユーザーがアプリを積極的に使用中にセッション更新が失敗した場合どうなるか？
- ナビゲーションで複数のタブを素早く切り替えた場合、アプリはどう処理するか？

## 要件 *(必須)*

### 機能要件

- **FR-001**: システムは初期ログイン画面にGoogleサインインボタンを提供しなければならない
- **FR-002**: システムはユーザーログインのためにGoogle OAuth 2.0認証フローを実装しなければならない
- **FR-003**: システムはSupabase Authを使用してユーザー認証トークンを安全に保存・管理しなければならない
- **FR-004**: システムは2つのタブ（地図、マイページ）を持つボトムタブナビゲーションバーを表示しなければならない
- **FR-005**: ユーザーはタブをタップしてタブ間を切り替えられなければならない
- **FR-006**: システムは現在アクティブなタブを視覚的に示さなければならない
- **FR-007**: システムはアプリ再起動後もユーザーセッションを30日間維持しなければならない
- **FR-008**: システムはセッションの継続性を維持するため、有効期限前に認証トークンを自動的に更新しなければならない
- **FR-009**: システムはマイページ画面からアクセス可能なログアウトボタンを提供しなければならない
- **FR-010**: システムはユーザーがログアウトした際にすべてのローカルセッションデータをクリアしなければならない
- **FR-011**: システムは未認証ユーザーが保護されたコンテンツにアクセスしようとした場合、ログイン画面にリダイレクトしなければならない
- **FR-012**: システムは認証エラーをユーザーフレンドリーなエラーメッセージで適切に処理しなければならない
- **FR-013**: システムはアプリ起動時とセッション再開時に認証トークンを検証しなければならない
- **FR-014**: システムはログアウト時にローカルとリモートの両方でユーザー認証状態を取り消さなければならない
- **FR-015**: 各タブ画面（地図、マイページ）は独立して読み込まれ、この初期実装フェーズでは適切なプレースホルダーコンテンツを表示しなければならない

### 主要エンティティ

- **ユーザー**: Googleアカウント情報（一意識別子、メールアドレス、表示名、プロフィール画像）を持つ認証済みアプリユーザーを表す
- **セッション**: アクティブなユーザー認証セッション（認証トークン、リフレッシュトークン、有効期限タイムスタンプ、作成タイムスタンプ）を表す
- **ナビゲーション状態**: セッション永続化のための現在のタブ選択と画面状態（アクティブタブ、画面固有の状態データ）を表す

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーはアプリ起動からメインナビゲーションの表示まで、Googleログインフローを30秒以内に完了できる
- **SC-002**: ユーザーの95%が初回試行で認証に成功する
- **SC-003**: 認証済みユーザーは2つのタブを500ミリ秒以内の遷移で切り替えられる
- **SC-004**: 再訪ユーザーの90%が認証状態を維持し、ログイン画面をバイパスする
- **SC-005**: ログアウトしたユーザーはログイン画面にリダイレクトされ、認証済みコンテンツにアクセスできない
- **SC-006**: セッションの永続化が30日以内に戻るユーザーの99%で正しく機能する
- **SC-007**: 認証エラーは、ユーザーが問題を解決するのに役立つ明確で実行可能なメッセージで提示される
- **SC-008**: アプリは認証中のネットワーク中断をクラッシュせずに処理し、適切な再試行メカニズムを提供する
